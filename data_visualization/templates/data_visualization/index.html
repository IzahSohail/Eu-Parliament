{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Vote Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'data_visualization/css/style.css' %}">
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid navigation">
            <a class="navbar-brand" href="{% url 'index' %}">Euro Votes</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{% url 'index' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">MEPs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="landing-container" style="background-image: url('{% static "data_visualization/images/eu_flag.jpg" %}');">
        <div class="content-wrapper">
            <!-- Search Section -->
            <div class="search-section">
                <h1>Search by Text or Date</h1>
                <form method="GET" action="{% url 'index' %}">
                    <div class="search-input-wrapper">
                        <input type="text" name="q" placeholder="Enter a date or description" value="{{ query }}" id="searchInput">
                        <!-- Calendar button next to search bar -->
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#calendarModal">
                            <i class="bi bi-calendar"></i> <!-- Calendar icon -->
                        </button>
                        <button type="submit" class="btn btn-primary search-button">Search</button>
                    </div>
                </form>
                <!-- Display the number of vote and MEP results found -->
                {% if vote_results or mep_results %}
                <p>{{ vote_results|length }} <a href="#vote-results">vote results</a> found and {{ mep_results|length }} <a href="#mep-results">MEP results</a> found</p>
                {% endif %}
    
            </div>

            <!-- Calendar Modal -->
            <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="calendarModalLabel">Select a Date</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="calendar-section">
                                <div class="calendar-container">
                                    <div class="calendar-header">
                                        <button type="button" id="prevMonth">←</button>
                                        <select id="yearSelect"></select>
                                        <select id="monthSelect">
                                            <option value="0">January</option>
                                            <option value="1">February</option>
                                            <option value="2">March</option>
                                            <option value="3">April</option>
                                            <option value="4">May</option>
                                            <option value="5">June</option>
                                            <option value="6">July</option>
                                            <option value="7">August</option>
                                            <option value="8">September</option>
                                            <option value="9">October</option>
                                            <option value="10">November</option>
                                            <option value="11">December</option>
                                        </select>
                                        <button type="button" id="nextMonth">→</button>
                                    </div>
                                    <div id="calendar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const calendar = document.getElementById('calendar');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const searchInput = document.getElementById('searchInput');
        const now = new Date();
        let currentMonth = now.getMonth();
        let currentYear = now.getFullYear();

        const votesByDate = JSON.parse('{{ votes_by_date|escapejs }}');

        function generateCalendar(year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            let table = '<table><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr><tr>';
            for (let i = 0; i < firstDay; i++) {
                table += '<td></td>';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const highlightClass = votesByDate[dateStr] ? 'highlight' : '';
                if ((firstDay + day - 1) % 7 === 0) {
                    table += '</tr><tr>';
                }
                table += `<td class="${highlightClass}" onclick="submitDate('${dateStr}')">${day}</td>`;
            }
            table += '</tr></table>';
            calendar.innerHTML = table;
        }

        function submitDate(date) {
            searchInput.value = date;
            const calendarModalEl = document.getElementById('calendarModal');
            const calendarModal = bootstrap.Modal.getInstance(calendarModalEl);
            if (calendarModal) {
                calendarModal.hide();  // Hide the modal after selecting the date
            }
            searchInput.form.submit();  // Automatically submit the form to show results
        }

        function populateYearSelect() {
            const startYear = currentYear - 20;
            const endYear = currentYear + 10;
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.add(option);
            }
        }

        function updateCalendar() {
            const selectedYear = parseInt(yearSelect.value);
            const selectedMonth = parseInt(monthSelect.value);
            generateCalendar(selectedYear, selectedMonth);
        }

        prevMonthButton.addEventListener('click', () => {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
            } else {
                currentMonth--;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            updateCalendar();
        });

        nextMonthButton.addEventListener('click', () => {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
            } else {
                currentMonth++;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            updateCalendar();
        });

        yearSelect.addEventListener('change', updateCalendar);
        monthSelect.addEventListener('change', updateCalendar);

        populateYearSelect();
        monthSelect.value = currentMonth;
        generateCalendar(currentYear, currentMonth);
    </script>

    {% if vote_results or mep_results %}
    <div class="search-results">
        
        <div id="vote-results">
            {% if vote_results %}
            <h3>Vote Results:</h3>
            <ul>
                {% for vote in vote_results %}
                <li class="vote-item">
                    <div class="vote-header">
                        <span class="vote-id">Vote {{ vote.vote_id }}</span> &gt; <span class="vote-date">{{ vote.date }}</span>
                    </div>
                    <div class="vote-body">
                        <div class="vote-title">
                            <strong>{{ vote.label }}</strong>
                        </div>
                        <a href="{% url 'vote_detail' vote_id=vote.vote_id %}" class="vote-detail-link">View Details</a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    
        <div id="mep-results">
            {% if mep_results %}
            <h3>MEP Results:</h3>
            <ul>
                {% for mep in mep_results %}
                <li class="mep-item">
                    <div class="mep-header">
                        <span class="mep-name">{{ mep.full_name }}</span> &gt; <span class="mep-country">{{ mep.country_of_representation }}</span>
                    </div>
                    <a href="{% url 'mep_info' mep.mep_id %}" class="mep-detail-link">View MEP Info</a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
    {% elif query %}
    <p>No results found for "{{ query }}".</p>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
